<div class="foodie-dashboard-container">
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <button class="hamburger-menu" (click)="toggleSidebar()" [class.active]="sidebarOpen">
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
      </button>
      <img src="assets/logo.png" alt="FoodiesBNB Logo" class="header-logo">
    </div>
  </header>

  <!-- Sidebar Menu -->
  <div class="sidebar-overlay" [class.active]="sidebarOpen" (click)="closeSidebar()"></div>
  <nav class="sidebar" [class.active]="sidebarOpen">
    <div class="sidebar-logo-section">
      <img src="assets/logo.png" alt="FoodiesBNB Logo" class="sidebar-logo">
    </div>
    <ul class="sidebar-menu">
      <li class="menu-item">
        <a class="menu-link active" (click)="navigateToSection('foodie'); $event.preventDefault()">
          <span class="menu-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"></path>
              <path d="M7 2v20"></path>
              <path d="M21 15V2a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"></path>
            </svg>
          </span>
          <span class="menu-text">Dashboard Foodie</span>
        </a>
      </li>
      <li class="menu-item">
        <a class="menu-link" (click)="goToDashboard(); $event.preventDefault()">
          <span class="menu-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 6h18"></path>
              <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
              <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
              <line x1="10" x2="10" y1="11" y2="17"></line>
              <line x1="14" x2="14" y1="11" y2="17"></line>
            </svg>
          </span>
          <span class="menu-text">Dashboard Principal</span>
        </a>
      </li>
      <li class="menu-item">
        <a class="menu-link" (click)="navigateToSection('visitas'); $event.preventDefault()">
          <span class="menu-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" x2="16" y1="2" y2="6"></line>
              <line x1="8" x2="8" y1="2" y2="6"></line>
              <line x1="3" x2="21" y1="10" y2="10"></line>
            </svg>
          </span>
          <span class="menu-text">Visitas Programadas</span>
        </a>
      </li>
      <li class="menu-item">
        <a class="menu-link" (click)="navigateToSection('cuenta'); $event.preventDefault()">
          <span class="menu-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </span>
          <span class="menu-text">Cuenta</span>
        </a>
      </li>
    </ul>
    <div class="sidebar-footer">
      <button class="logout-btn" (click)="logout()">
        <span class="menu-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16,17 21,12 16,7"></polyline>
            <line x1="21" x2="9" y1="12" y2="12"></line>
          </svg>
        </span>
        <span class="menu-text">Cerrar Sesión</span>
      </button>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Header Section -->
    <div class="dashboard-header">
      <h1 class="dashboard-title">Panel del Foodie</h1>
      <p class="dashboard-subtitle">Explora y conecta con restaurantes locales.</p>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <button 
        class="tab-button"
        [class.active]="activeTab === 'explorar'"
        (click)="setActiveTab('explorar')">
        Explorar Restaurantes
      </button>
      <button 
        class="tab-button"
        [class.active]="activeTab === 'visitas'"
        (click)="setActiveTab('visitas')">
        Mis Visitas
      </button>
      <button 
        class="tab-button"
        [class.active]="activeTab === 'evidencias'"
        (click)="setActiveTab('evidencias')">
        Evidencias
      </button>
    </div>

    <!-- Search and Filters -->
    <!-- Search and Filters -->
    <div class="search-filters-section" *ngIf="activeTab === 'explorar'">
      <div class="search-container">
        <div class="search-input-wrapper">
          <input type="text" placeholder="Buscar restaurantes por nombre..." [(ngModel)]="searchTerm">
          <span class="search-icon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="21 21l-4.35-4.35"></path>
            </svg>
          </span>
        </div>
      </div>
      <div class="filters-container">
        <div class="filter-group">
          <span class="location-icon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
          </span>
          <select class="filter-select" [(ngModel)]="locationFilter">
            <option value="">Ubicación</option>
            <option value="cumbaya">Cumbayá</option>
            <option value="quito">Quito</option>
            <option value="guayaquil">Guayaquil</option>
          </select>
        </div>
        <div class="filter-group">
          <span class="filter-icon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"></path>
              <path d="M7 2v20"></path>
              <path d="M21 15V2a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"></path>
            </svg>
          </span>
          <select class="filter-select" [(ngModel)]="cuisineFilter">
            <option value="">Tipo de cocina</option>
            <option value="brunch-pizza-pasta">Brunch-Pizza-Pasta</option>
            <option value="grill">Grill</option>
            <option value="sushi">Sushi</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Restaurants Grid -->
    <div class="restaurants-grid" *ngIf="activeTab === 'explorar'">
      <div class="restaurant-card" *ngFor="let restaurant of restaurants">
        <!-- Benefits Badge -->
        <div class="benefits-badge" *ngIf="restaurant.hasBenefits">
          <i class="fas fa-star"></i>
          Beneficios
        </div>
        
        <!-- Restaurant Image -->
        <div class="restaurant-image">
          <img [src]="restaurant.image" [alt]="restaurant.name">
        </div>

        <!-- Restaurant Info -->
        <div class="restaurant-info">
          <div class="restaurant-header">
            <h3 class="restaurant-name">{{ restaurant.name }}</h3>
            <div class="restaurant-rating">
              <div class="stars">
                <span *ngFor="let star of generateStars(restaurant.rating)" 
                      [class.filled]="star === '★'">★</span>
              </div>
              <span class="rating-text">{{ restaurant.rating }} ({{ restaurant.reviews }})</span>
            </div>
          </div>

          <p class="restaurant-category">{{ restaurant.category }}</p>

          <div class="restaurant-details">
            <div class="detail-item">
              <i class="fas fa-map-marker-alt"></i>
              <span>{{ restaurant.location }}</span>
            </div>
            <div class="detail-item">
              <i class="fas fa-clock"></i>
              <span>{{ restaurant.hours }}</span>
            </div>
          </div>

          <p class="restaurant-description">{{ restaurant.description }}</p>

          <div class="benefits-section" *ngIf="restaurant.hasBenefits">
            <h4>Beneficios exclusivos:</h4>
          </div>

          <div class="restaurant-footer">
            <div class="price-range">{{ restaurant.price }}</div>
            <div class="action-buttons">
              <button class="btn-primary" (click)="scheduleVisit(restaurant)">Programar Visita</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Evidencias Tab Content -->
    <div class="evidencias-content" *ngIf="activeTab === 'evidencias'">
      <div class="evidencias-header">
        <h3><i class="fas fa-camera"></i> Subir Evidencias de Visitas</h3>
        <p>Después de tu visita, tienes 48 horas para subir las evidencias</p>
      </div>

      <div class="visitas-pendientes" *ngIf="getVisitsForEvidence().length > 0">
        <div class="visita-evidencia-card" *ngFor="let visita of getVisitsForEvidence()">
          <div class="visita-info">
            <h4>{{ visita.restaurante.nombre }}</h4>
            <p><i class="fas fa-calendar-alt"></i> {{ formatDate(visita.fecha) }} - {{ visita.hora }}</p>
            <p><i class="fas fa-users"></i> {{ visita.numeroPersonas }} persona(s)</p>
            <p class="tiempo-restante"><i class="fas fa-clock"></i> Tiempo restante: {{ getRemainingTime(visita.fecha) }}</p>
          </div>

          <div class="evidencias-form" *ngIf="!hasEvidence(visita.id)">
            <form (ngSubmit)="submitEvidence(visita.id)">
              <div class="form-group">
                <label for="tiktok_{{visita.id}}"><i class="fab fa-tiktok"></i> Enlace de TikTok generado:</label>
                <input 
                  type="url" 
                  id="tiktok_{{visita.id}}"
                  [value]="evidenceForm[visita.id]?.tiktokUrl || ''"
                  (input)="updateEvidenceForm(visita.id, 'tiktokUrl', $event)"
                  name="tiktok"
                  placeholder="https://tiktok.com/@usuario/video/..."
                  required>
              </div>

              <div class="form-group">
                <label for="instagram_{{visita.id}}"><i class="fab fa-instagram"></i> Foto de historia de Instagram:</label>
                <input 
                  type="file" 
                  id="instagram_{{visita.id}}"
                  (change)="onInstagramPhotoSelected($event, visita.id)"
                  accept="image/*"
                  required>
                <small>Formatos aceptados: JPG, PNG, WEBP</small>
              </div>

              <div class="form-group">
                <label for="gasto_{{visita.id}}"><i class="fas fa-dollar-sign"></i> Cantidad gastada en la visita (USD):</label>
                <input 
                  type="number" 
                  id="gasto_{{visita.id}}"
                  [value]="evidenceForm[visita.id]?.amountSpent || ''"
                  (input)="updateEvidenceForm(visita.id, 'amountSpent', $event)"
                  name="gasto"
                  min="0"
                  step="0.01"
                  placeholder="0.00"
                  required>
              </div>

              <button type="submit" class="submit-evidencias-btn">
                <i class="fas fa-upload"></i> Subir Evidencias
              </button>
            </form>
          </div>

          <div class="evidencias-enviadas" *ngIf="hasEvidence(visita.id)">
            <div class="evidencias-status">
              <h4><i class="fas fa-check-circle"></i> Evidencias enviadas</h4>
              <p>Tus evidencias han sido recibidas correctamente</p>
            </div>
          </div>
        </div>
      </div>

      <div class="no-visitas-evidencias" *ngIf="getVisitsForEvidence().length === 0">
        <div class="empty-state">
          <div class="empty-icon"><i class="fas fa-camera"></i></div>
          <h3>No hay visitas pendientes de evidencias</h3>
          <p>Las visitas completadas aparecerán aquí para que subas tus evidencias</p>
        </div>
      </div>
    </div>

    <!-- Mis Visitas Tab Content -->
    <div class="tab-content" *ngIf="activeTab === 'visitas'">
      <div class="visits-section">
        <div class="section-header">
          <h3>Mis Visitas Programadas</h3>
          <button class="refresh-btn" (click)="loadVisits()">
            <i class="fas fa-refresh"></i> Actualizar
          </button>
        </div>

        <!-- Visit Tabs -->
        <div class="visit-tabs">
          <button 
            class="visit-tab-btn" 
            [class.active]="selectedVisitTab === 'all'"
            (click)="selectVisitTab('all')">
            Todas ({{ getVisitCountByStatus('all') }})
          </button>
          <button 
            class="visit-tab-btn" 
            [class.active]="selectedVisitTab === 'programada'"
            (click)="selectVisitTab('programada')">
            Programadas ({{ getVisitCountByStatus('programada') }})
          </button>
          <button 
            class="visit-tab-btn" 
            [class.active]="selectedVisitTab === 'completada'"
            (click)="selectVisitTab('completada')">
            Completadas ({{ getVisitCountByStatus('completada') }})
          </button>
          <button 
            class="visit-tab-btn" 
            [class.active]="selectedVisitTab === 'cancelada'"
            (click)="selectVisitTab('cancelada')">
            Canceladas ({{ getVisitCountByStatus('cancelada') }})
          </button>
        </div>

        <!-- Visit Content -->
        <div class="visits-content">
          <!-- Loading State -->
          <div *ngIf="isLoadingVisits" class="loading-state">
            <div class="spinner"></div>
            <p>Cargando visitas...</p>
          </div>

          <!-- Empty State -->
          <div *ngIf="!isLoadingVisits && filterVisitsByStatus(selectedVisitTab === 'all' ? undefined : selectedVisitTab).length === 0" class="empty-visits-state">
            <div class="empty-icon">📅</div>
            <h4>No hay visitas {{ selectedVisitTab === 'all' ? '' : 'en esta categoría' }}</h4>
            <p>Cuando programes visitas a restaurantes, aparecerán aquí.</p>
          </div>

          <!-- Visits List -->
          <div class="visits-list" *ngIf="!isLoadingVisits && filterVisitsByStatus(selectedVisitTab === 'all' ? undefined : selectedVisitTab).length > 0">
            <div 
              class="visit-card" 
              *ngFor="let visit of filterVisitsByStatus(selectedVisitTab === 'all' ? undefined : selectedVisitTab)"
              [class]="getStatusClass(visit.estado)">
              
              <div class="visit-header">
                <div class="restaurant-info">
                  <h4>{{ visit.restaurante.nombre }}</h4>
                  <p class="restaurant-address">{{ visit.restaurante.ubicacion }}</p>
                  <p class="restaurant-type">{{ visit.restaurante.tipo }}</p>
                </div>
                <div class="visit-status">
                  <span class="status-badge" [class]="getStatusClass(visit.estado)">
                    {{ getStatusText(visit.estado) }}
                  </span>
                </div>
              </div>

              <div class="visit-details">
                <div class="detail-item">
                  <span class="detail-icon">📅</span>
                  <span class="detail-text">{{ formatDate(visit.fecha) }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-icon">🕐</span>
                  <span class="detail-text">{{ formatTime(visit.hora) }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-icon">👥</span>
                  <span class="detail-text">{{ visit.numeroPersonas }} {{ visit.numeroPersonas === 1 ? 'persona' : 'personas' }}</span>
                </div>
                <div class="detail-item" *ngIf="visit.codigoReserva">
                  <span class="detail-icon">🎫</span>
                  <span class="detail-text">Código: {{ visit.codigoReserva }}</span>
                </div>
              </div>

              <div class="visit-notes" *ngIf="visit.notasEspeciales">
                <p><strong>Notas especiales:</strong> {{ visit.notasEspeciales }}</p>
              </div>

              <div class="visit-actions">
                <div class="visit-dates">
                  <small class="created-date">
                    Creada: {{ formatDate(visit.fechaCreacion!) }}
                  </small>
                </div>
                
                <div class="action-buttons">
                  <button 
                    class="cancel-btn" 
                    *ngIf="visit.estado === 'programada' || visit.estado === 'confirmada'"
                    (click)="cancelVisit(visit.id)">
                    Cancelar Visita
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Visit Modal -->
<app-visit-modal 
  [isOpen]="isVisitModalOpen"
  [restaurant]="selectedRestaurant"
  (close)="closeVisitModal()"
  (visitCreated)="onVisitCreated()">
</app-visit-modal>
